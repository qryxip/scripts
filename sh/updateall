#!/bin/sh

set -euE -o pipefail

if [ "$TERM" = dumb ]; then
  yellow=''
  bold=''
  ansi_reset=''
else
  yellow=`echo -e '\e[33m'`
  bold=`echo -e '\e[1m'`
  ansi_reset=`echo -e '\e[m'`
fi

if [ "`whoami`" = root ]; then
  echo "${yellow}Don't run this script as root.${ansi_reset}"
  exit 1
fi

echo "${bold}yay${ansi_reset}"
PATH=/usr/bin:$PATH yay -Syu

if [ -e /opt/xkeysnail/bin/pip3 ]; then
  echo -e "\n${bold}pip3 (xkeysnail)${ansi_reset}"
  sudo /opt/xkeysnail/bin/pip3 install -U pip xkeysnail
fi

if [ -e ~/venvs/playground/bin/pip3 ]; then
  echo -e "\n${bold}pip3 (playground)${ansi_reset}"
  packages=`~/venvs/playground/bin/pip3 list -o | tail +3 | awk '{print $1}'`
  if [ -n "$packages" ]; then
    echo $packages | xargs ~/venvs/playground/bin/pip3 install -U
  else
    echo 'No package to update'
  fi
fi

if [ -e ~/venvs/http/bin/pip3 ]; then
  echo -e "\n${bold}pip3 (http)${ansi_reset}"
  ~/venvs/http/bin/pip3 install -U pip httpie
fi

if [ -e ~/venvs/pygmentize/bin/pip3 ]; then
  echo -e "\n${bold}pip3 (pygmentize)${ansi_reset}"
  ~/venvs/pygmentize/bin/pip3 install -U pip tw2.pygmentize
fi

if [ -e ~/venvs/ranger/bin/pip3 ]; then
  echo -e "\n${bold}pip3 (ranger)${ansi_reset}"
  ~/venvs/ranger/bin/pip3 install -U pip ranger-fm
fi

if [ -e ~/venvs/oj/bin/pip3 ]; then
  echo -e "\n${bold}pip3 (oj)${ansi_reset}"
  ~/venvs/oj/bin/pip3 install -U pip online-judge-tools
fi

if which npm > /dev/null 2>&1; then
  if which npm | grep ~ > /dev/null 2>&1; then
    echo -e "\n${bold}npm (LTS)${ansi_reset}"
    if [ -z "$(npm update -g)" ]; then
      echo "${bold}No packages to update.${ansi_reset}"
    fi
  fi
fi

if false; then
  echo -e "\n${bold}Go${ansi_reset}"
  go get -u all
fi

if [ -e ~/.cargo/bin/rustup ]; then
  echo -e "\n${bold}Cargo${ansi_reset}"
  ~/.cargo/bin/rustup self update
  if [ -z $(cargo install-update -la | sed -n 's/^racer[0-9v\. ]\+\(No\)/\1/gp') ]; then
    ~/.cargo/bin/rustup update nightly
    ~/.cargo/bin/cargo +nightly install-update racer
  fi
  ~/.cargo/bin/rustup update stable
  ~/.cargo/bin/cargo +stable install-update -ag
fi
